{"https://moirai2.github.io/schema/daemon/bash":["output=$tmpdir/fantom4.humanCAGE.fq.gz","mkdir -p $tmpdir/download","mkdir -p $tmpdir/download","perl $tmpdir/download.pl http://fantom.gsc.riken.jp/4/download/Tables/human/CAGE/mapping/h04_mapping.tbl.txt.bz2 $tmpdir/download","perl $tmpdir/download.pl http://fantom.gsc.riken.jp/4/download/Tables/human/CAGE/mapping/h05_mapping.tbl.txt.bz2 $tmpdir/download","perl $tmpdir/download.pl http://fantom.gsc.riken.jp/4/download/Tables/human/CAGE/mapping/h06_mapping.tbl.txt.bz2 $tmpdir/download","perl $tmpdir/download.pl http://fantom.gsc.riken.jp/4/download/Tables/human/CAGE/mapping/h08_mapping.tbl.txt.bz2 $tmpdir/download",
"perl $tmpdir/download.pl http://fantom.gsc.riken.jp/4/download/Tables/human/CAGE/mapping/h09_mapping.tbl.txt.bz2 $tmpdir/download","perl $tmpdir/download.pl http://fantom.gsc.riken.jp/4/download/Tables/human/CAGE/mapping/h10_mapping.tbl.txt.bz2 $tmpdir/download","perl $tmpdir/download.pl http://fantom.gsc.riken.jp/4/download/Tables/human/CAGE/mapping/h11_mapping.tbl.txt.bz2 $tmpdir/download","perl $tmpdir/download.pl http://fantom.gsc.riken.jp/4/download/Tables/human/CAGE/mapping/h15_mapping.tbl.txt.bz2 $tmpdir/download","perl $tmpdir/download.pl http://fantom.gsc.riken.jp/4/download/Tables/human/CAGE/mapping/h21_mapping.tbl.txt.bz2 $tmpdir/download","perl $tmpdir/download.pl http://fantom.gsc.riken.jp/4/download/Tables/human/CAGE/mapping/h22_mapping.tbl.txt.bz2 $tmpdir/download","perl $tmpdir/download.pl http://fantom.gsc.riken.jp/4/download/Tables/human/CAGE/mapping/h27_mapping.tbl.txt.bz2 $tmpdir/download","perl $tmpdir/download.pl http://fantom.gsc.riken.jp/4/download/Tables/human/CAGE/mapping/h28_mapping.tbl.txt.bz2 $tmpdir/download","perl $tmpdir/download.pl http://fantom.gsc.riken.jp/4/download/Tables/human/CAGE/mapping/h33_mapping.tbl.txt.bz2 $tmpdir/download","perl $tmpdir/download.pl http://fantom.gsc.riken.jp/4/download/Tables/human/CAGE/mapping/h34_mapping.tbl.txt.bz2 $tmpdir/download","perl $tmpdir/download.pl http://fantom.gsc.riken.jp/4/download/Tables/human/CAGE/mapping/h35_mapping.tbl.txt.bz2 $tmpdir/download","perl $tmpdir/download.pl http://fantom.gsc.riken.jp/4/download/Tables/human/CAGE/mapping/h37_mapping.tbl.txt.bz2 $tmpdir/download","perl $tmpdir/download.pl http://fantom.gsc.riken.jp/4/download/Tables/human/CAGE/mapping/h39_mapping.tbl.txt.bz2 $tmpdir/download",
"perl $tmpdir/download.pl http://fantom.gsc.riken.jp/4/download/Tables/human/CAGE/mapping/h40_mapping.tbl.txt.bz2 $tmpdir/download","perl $tmpdir/download.pl http://fantom.gsc.riken.jp/4/download/Tables/human/CAGE/mapping/h42_mapping.tbl.txt.bz2 $tmpdir/download","perl $tmpdir/download.pl http://fantom.gsc.riken.jp/4/download/Tables/human/CAGE/mapping/h43_mapping.tbl.txt.bz2 $tmpdir/download","perl $tmpdir/download.pl http://fantom.gsc.riken.jp/4/download/Tables/human/CAGE/mapping/h45_mapping.tbl.txt.bz2 $tmpdir/download",
"perl $tmpdir/download.pl http://fantom.gsc.riken.jp/4/download/Tables/human/CAGE/mapping/h47_mapping.tbl.txt.bz2 $tmpdir/download",
"perl $tmpdir/download.pl http://fantom.gsc.riken.jp/4/download/Tables/human/CAGE/mapping/h48_mapping.tbl.txt.bz2 $tmpdir/download",
"perl $tmpdir/download.pl http://fantom.gsc.riken.jp/4/download/Tables/human/CAGE/mapping/h49_mapping.tbl.txt.bz2 $tmpdir/download",
"perl $tmpdir/download.pl http://fantom.gsc.riken.jp/4/download/Tables/human/CAGE/mapping/h51_mapping.tbl.txt.bz2 $tmpdir/download",
"perl $tmpdir/download.pl http://fantom.gsc.riken.jp/4/download/Tables/human/CAGE/mapping/h52_mapping.tbl.txt.bz2 $tmpdir/download",
"perl $tmpdir/download.pl http://fantom.gsc.riken.jp/4/download/Tables/human/CAGE/mapping/h53_mapping.tbl.txt.bz2 $tmpdir/download",
"perl $tmpdir/download.pl http://fantom.gsc.riken.jp/4/download/Tables/human/CAGE/mapping/h57_mapping.tbl.txt.bz2 $tmpdir/download",
"perl $tmpdir/download.pl http://fantom.gsc.riken.jp/4/download/Tables/human/CAGE/mapping/h59_mapping.tbl.txt.bz2 $tmpdir/download","perl $tmpdir/download.pl http://fantom.gsc.riken.jp/4/download/Tables/human/CAGE/mapping/h61_mapping.tbl.txt.bz2 $tmpdir/download",
"perl $tmpdir/download.pl http://fantom.gsc.riken.jp/4/download/Tables/human/CAGE/mapping/h62_mapping.tbl.txt.bz2 $tmpdir/download",
"perl $tmpdir/download.pl http://fantom.gsc.riken.jp/4/download/Tables/human/CAGE/mapping/h63_mapping.tbl.txt.bz2 $tmpdir/download",
"perl $tmpdir/download.pl http://fantom.gsc.riken.jp/4/download/Tables/human/CAGE/mapping/h64_mapping.tbl.txt.bz2 $tmpdir/download",
"perl $tmpdir/download.pl http://fantom.gsc.riken.jp/4/download/Tables/human/CAGE/mapping/h65_mapping.tbl.txt.bz2 $tmpdir/download","perl $tmpdir/download.pl http://fantom.gsc.riken.jp/4/download/Tables/human/CAGE/mapping/h69_mapping.tbl.txt.bz2 $tmpdir/download","perl $tmpdir/download.pl http://fantom.gsc.riken.jp/4/download/Tables/human/CAGE/mapping/h73_mapping.tbl.txt.bz2 $tmpdir/download","perl $tmpdir/download.pl http://fantom.gsc.riken.jp/4/download/Tables/human/CAGE/mapping/h74_mapping.tbl.txt.bz2 $tmpdir/download","perl $tmpdir/download.pl http://fantom.gsc.riken.jp/4/download/Tables/human/CAGE/mapping/h91_mapping.tbl.txt.bz2 $tmpdir/download","perl $tmpdir/download.pl http://fantom.gsc.riken.jp/4/download/Tables/human/CAGE/mapping/h92_mapping.tbl.txt.bz2 $tmpdir/download","perl $tmpdir/download.pl http://fantom.gsc.riken.jp/4/download/Tables/human/CAGE/mapping/h93_mapping.tbl.txt.bz2 $tmpdir/download",
"perl $tmpdir/download.pl http://fantom.gsc.riken.jp/4/download/Tables/human/CAGE/mapping/h95ctrls_mapping.tbl.txt.bz2 $tmpdir/download","perl $tmpdir/download.pl http://fantom.gsc.riken.jp/4/download/Tables/human/CAGE/mapping/i02_mapping.tbl.txt.bz2 $tmpdir/download","perl $tmpdir/download.pl http://fantom.gsc.riken.jp/4/download/Tables/human/CAGE/mapping/i03_mapping.tbl.txt.bz2 $tmpdir/download","temp=\"$tmpdir/output.sam\"","output=\"$tmpdir/output.bam\"","perl $tmpdir/convert_mapping_table_to_sam.pl $tmpdir/download/*.bz2 > $temp","samtools view -bSo $output $temp 2>/dev/null","rm -r $tmpdir/download","rm $temp"],"https://moirai2.github.io/schema/daemon/script":[{"https://moirai2.github.io/schema/daemon/script/name":"$tmpdir/download.pl","https://moirai2.github.io/schema/daemon/script/code":["use LWP::UserAgent;","use HTTP::Request;","use File::Basename;","my $url=shift(@ARGV);","my $outdir=shift(@ARGV);","my $agent=new LWP::UserAgent();","$agent->agent('download.pl/1.0');","$agent->timeout(10);","$agent->env_proxy;","my $request=HTTP::Request->new(GET=>$url);","my $filename=\"$outdir/\".basename($url);","my $res=$agent->request($request);","if($res->is_success){","open(OUT,\">$filename\");","print OUT $res->content;","close(OUT);","}elsif($res->is_error){","exit(1);","}"]},{"https://moirai2.github.io/schema/daemon/script/name":"$tmpdir/convert_mapping_table_to_sam.pl","https://moirai2.github.io/schema/daemon/script/code":["use strict 'vars';","use FileHandle;","use File::Basename;","print \"\\@SQ\\tSN:chr1\\tAS:chrom.sizes\\tLN:247249719\\n\";","print \"\\@SQ\\tSN:chr2\\tAS:chrom.sizes\\tLN:242951149\\n\";","print \"\\@SQ\\tSN:chr3\\tAS:chrom.sizes\\tLN:199501827\\n\";","print \"\\@SQ\\tSN:chr4\\tAS:chrom.sizes\\tLN:191273063\\n\";","print \"\\@SQ\\tSN:chr5\\tAS:chrom.sizes\\tLN:180857866\\n\";","print \"\\@SQ\\tSN:chr6\\tAS:chrom.sizes\\tLN:170899992\\n\";","print \"\\@SQ\\tSN:chr7\\tAS:chrom.sizes\\tLN:158821424\\n\";","print \"\\@SQ\\tSN:chr8\\tAS:chrom.sizes\\tLN:146274826\\n\";","print \"\\@SQ\\tSN:chr9\\tAS:chrom.sizes\\tLN:140273252\\n\";","print \"\\@SQ\\tSN:chr10\\tAS:chrom.sizes\\tLN:135374737\\n\";","print \"\\@SQ\\tSN:chr11\\tAS:chrom.sizes\\tLN:134452384\\n\";","print \"\\@SQ\\tSN:chr12\\tAS:chrom.sizes\\tLN:132349534\\n\";","print \"\\@SQ\\tSN:chr13\\tAS:chrom.sizes\\tLN:114142980\\n\";","print \"\\@SQ\\tSN:chr14\\tAS:chrom.sizes\\tLN:106368585\\n\";","print \"\\@SQ\\tSN:chr15\\tAS:chrom.sizes\\tLN:100338915\\n\";","print \"\\@SQ\\tSN:chr16\\tAS:chrom.sizes\\tLN:88827254\\n\";","print \"\\@SQ\\tSN:chr17\\tAS:chrom.sizes\\tLN:78774742\\n\";","print \"\\@SQ\\tSN:chr18\\tAS:chrom.sizes\\tLN:76117153\\n\";","print \"\\@SQ\\tSN:chr19\\tAS:chrom.sizes\\tLN:63811651\\n\";","print \"\\@SQ\\tSN:chr20\\tAS:chrom.sizes\\tLN:62435964\\n\";","print \"\\@SQ\\tSN:chr21\\tAS:chrom.sizes\\tLN:46944323\\n\";","print \"\\@SQ\\tSN:chr22\\tAS:chrom.sizes\\tLN:49691432\\n\";","print \"\\@SQ\\tSN:chrM\\tAS:chrom.sizes\\tLN:16571\\n\";","print \"\\@SQ\\tSN:chrX\\tAS:chrom.sizes\\tLN:154913754\\n\";","print \"\\@SQ\\tSN:chrY\\tAS:chrom.sizes\\tLN:57772954\\n\";","foreach my $file(@ARGV){","  my $basename=basename($file,\"_mapping.tbl.txt.bz2\");","  my $reader=IO::File->new(\"bzip2 -cd $file|\");","  my $preseq;","  my @token;","  while(<$reader>){","    if(/^##/){next;}","    my $line=<$reader>;","    chomp($line);","    @token=split(/\\t/,$line);","    $preseq=$token[0];","    last;","  }","  my $hash={\"reader\"=>$reader,\"token\"=>[\\@token],\"preseq\"=>$preseq};","  while(defined($preseq)){","    my @token=read_next($hash);","    print_seq($basename,@token);","    $preseq=$hash->{\"preseq\"};","  }","  close($reader);","}","sub print_seq{","  my @lines=@_;","  my $basename=shift(@lines);","  my $maxweight=0;","  foreach my $line(@lines){if($line->[15]>$maxweight){$maxweight=$line->[15];}}","  my $linecount=0;","  foreach my $line(@lines){","    my ($seq,$library_count,$edit_string,$rname,$strand,$start,$end,$percentage,$map_pos,$ribo_flag,$refseq_flag,$rna,$rna_count,$tpm_in_ribo,$tpm_ex_ribo,$weight,$rescue_weight)=@{$line};","    if($weight<$maxweight){next;}","    $rna=~tr/ /_/;","    my $length=length($seq);","    my $qual=\"\";","    for(my $i=0;$i<$length;$i++){$qual.=\"/\";}","    my $flag=0;","    my $pos=$start;","    if($strand eq\"-\"){$flag+=16;$pos=$end;}","    my $cigar=$length.\"M\";","    if($edit_string eq\"ORIGINAL\"){","    }else{","      $cigar=\"\";","      my $index=0;","      foreach my $c(split(/,/,$edit_string)){","        if($c=~/^(\\w)(\\d+)/){","          my $edit=$1;","          my $pos=$2;","          if($edit eq\"M\"){","          }elsif($edit eq\"I\"){","            $cigar.=($pos-$index).\"M\";","            $cigar.=\"1D\";","            $index=$pos;","          }elsif($edit eq\"D\"){","            if($index<$pos){$cigar.=($pos-$index).\"M\";}","            if($pos==$index||$pos==$length-1){$cigar.=\"1S\";}","            else{$cigar.=\"1I\";}","            $index=$pos;","            $length--;","          }","        }","      }","      if($index<$length){$cigar.=($length-$index).\"M\";}","    }","    $cigar=~s/1S1S/2S/;","    my $flag2=$flag;","    if($linecount>0){$flag2+=256;}","    for(my $j=0;$j<$rna_count;$j++){","      my $id=\"$basename|$rna|$seq|\".($j+1);","      my $count=scalar(@lines);","      my $mapq=($count>1)?int(-10*log(1-1/$count)):255;","      print \"$id\\t$flag2\\t$rname\\t$pos\\t$mapq\\t$cigar\\t*\\t0\\t0\\t$seq\\t$qual\\n\";","    }","    $linecount++;","  }","}","sub read_next{","  my $hash=shift();","  my $reader=$hash->{\"reader\"};","  my $preseq=$hash->{\"preseq\"};","  my @array=@{$hash->{\"token\"}};","  while(!eof($reader)){","    my $line=<$reader>;","    chomp($line);","    my @token=split(/\\t/,$line);","    my $sequence=$token[0];","    if($sequence eq $preseq){","      push(@array,\\@token);","    }else{","      $hash->{\"preseq\"}=$sequence;","      $hash->{\"token\"}=[\\@token];","      last;","    }","  }","  if(eof($reader)){delete($hash->{\"preseq\"});}","  return @array;","}"]}],"https://moirai2.github.io/schema/daemon/output":"$output"}
