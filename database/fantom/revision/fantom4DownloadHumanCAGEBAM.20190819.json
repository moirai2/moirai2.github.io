{"https://moirai2.github.io/schema/daemon/bash":["output=$tmpdir/fantom4.humanCAGE.fq.gz","mkdir -p $tmpdir/download","mkdir -p $tmpdir/download","perl $tmpdir/download.pl http://fantom.gsc.riken.jp/4/download/Tables/human/CAGE/mapping/h04_mapping.tbl.txt.bz2 $tmpdir/download","perl $tmpdir/download.pl http://fantom.gsc.riken.jp/4/download/Tables/human/CAGE/mapping/h05_mapping.tbl.txt.bz2 $tmpdir/download","perl $tmpdir/download.pl http://fantom.gsc.riken.jp/4/download/Tables/human/CAGE/mapping/h06_mapping.tbl.txt.bz2 $tmpdir/download","perl $tmpdir/download.pl http://fantom.gsc.riken.jp/4/download/Tables/human/CAGE/mapping/h08_mapping.tbl.txt.bz2 $tmpdir/download",
"perl $tmpdir/download.pl http://fantom.gsc.riken.jp/4/download/Tables/human/CAGE/mapping/h09_mapping.tbl.txt.bz2 $tmpdir/download","perl $tmpdir/download.pl http://fantom.gsc.riken.jp/4/download/Tables/human/CAGE/mapping/h10_mapping.tbl.txt.bz2 $tmpdir/download","perl $tmpdir/download.pl http://fantom.gsc.riken.jp/4/download/Tables/human/CAGE/mapping/h11_mapping.tbl.txt.bz2 $tmpdir/download","perl $tmpdir/download.pl http://fantom.gsc.riken.jp/4/download/Tables/human/CAGE/mapping/h15_mapping.tbl.txt.bz2 $tmpdir/download","perl $tmpdir/download.pl http://fantom.gsc.riken.jp/4/download/Tables/human/CAGE/mapping/h21_mapping.tbl.txt.bz2 $tmpdir/download","perl $tmpdir/download.pl http://fantom.gsc.riken.jp/4/download/Tables/human/CAGE/mapping/h22_mapping.tbl.txt.bz2 $tmpdir/download","perl $tmpdir/download.pl http://fantom.gsc.riken.jp/4/download/Tables/human/CAGE/mapping/h27_mapping.tbl.txt.bz2 $tmpdir/download","perl $tmpdir/download.pl http://fantom.gsc.riken.jp/4/download/Tables/human/CAGE/mapping/h28_mapping.tbl.txt.bz2 $tmpdir/download","perl $tmpdir/download.pl http://fantom.gsc.riken.jp/4/download/Tables/human/CAGE/mapping/h33_mapping.tbl.txt.bz2 $tmpdir/download","perl $tmpdir/download.pl http://fantom.gsc.riken.jp/4/download/Tables/human/CAGE/mapping/h34_mapping.tbl.txt.bz2 $tmpdir/download","perl $tmpdir/download.pl http://fantom.gsc.riken.jp/4/download/Tables/human/CAGE/mapping/h35_mapping.tbl.txt.bz2 $tmpdir/download","perl $tmpdir/download.pl http://fantom.gsc.riken.jp/4/download/Tables/human/CAGE/mapping/h37_mapping.tbl.txt.bz2 $tmpdir/download","perl $tmpdir/download.pl http://fantom.gsc.riken.jp/4/download/Tables/human/CAGE/mapping/h39_mapping.tbl.txt.bz2 $tmpdir/download",
"perl $tmpdir/download.pl http://fantom.gsc.riken.jp/4/download/Tables/human/CAGE/mapping/h40_mapping.tbl.txt.bz2 $tmpdir/download","perl $tmpdir/download.pl http://fantom.gsc.riken.jp/4/download/Tables/human/CAGE/mapping/h42_mapping.tbl.txt.bz2 $tmpdir/download","perl $tmpdir/download.pl http://fantom.gsc.riken.jp/4/download/Tables/human/CAGE/mapping/h43_mapping.tbl.txt.bz2 $tmpdir/download","perl $tmpdir/download.pl http://fantom.gsc.riken.jp/4/download/Tables/human/CAGE/mapping/h45_mapping.tbl.txt.bz2 $tmpdir/download",
"perl $tmpdir/download.pl http://fantom.gsc.riken.jp/4/download/Tables/human/CAGE/mapping/h47_mapping.tbl.txt.bz2 $tmpdir/download",
"perl $tmpdir/download.pl http://fantom.gsc.riken.jp/4/download/Tables/human/CAGE/mapping/h48_mapping.tbl.txt.bz2 $tmpdir/download",
"perl $tmpdir/download.pl http://fantom.gsc.riken.jp/4/download/Tables/human/CAGE/mapping/h49_mapping.tbl.txt.bz2 $tmpdir/download",
"perl $tmpdir/download.pl http://fantom.gsc.riken.jp/4/download/Tables/human/CAGE/mapping/h51_mapping.tbl.txt.bz2 $tmpdir/download",
"perl $tmpdir/download.pl http://fantom.gsc.riken.jp/4/download/Tables/human/CAGE/mapping/h52_mapping.tbl.txt.bz2 $tmpdir/download",
"perl $tmpdir/download.pl http://fantom.gsc.riken.jp/4/download/Tables/human/CAGE/mapping/h53_mapping.tbl.txt.bz2 $tmpdir/download",
"perl $tmpdir/download.pl http://fantom.gsc.riken.jp/4/download/Tables/human/CAGE/mapping/h57_mapping.tbl.txt.bz2 $tmpdir/download",
"perl $tmpdir/download.pl http://fantom.gsc.riken.jp/4/download/Tables/human/CAGE/mapping/h59_mapping.tbl.txt.bz2 $tmpdir/download","perl $tmpdir/download.pl http://fantom.gsc.riken.jp/4/download/Tables/human/CAGE/mapping/h61_mapping.tbl.txt.bz2 $tmpdir/download",
"perl $tmpdir/download.pl http://fantom.gsc.riken.jp/4/download/Tables/human/CAGE/mapping/h62_mapping.tbl.txt.bz2 $tmpdir/download",
"perl $tmpdir/download.pl http://fantom.gsc.riken.jp/4/download/Tables/human/CAGE/mapping/h63_mapping.tbl.txt.bz2 $tmpdir/download",
"perl $tmpdir/download.pl http://fantom.gsc.riken.jp/4/download/Tables/human/CAGE/mapping/h64_mapping.tbl.txt.bz2 $tmpdir/download",
"perl $tmpdir/download.pl http://fantom.gsc.riken.jp/4/download/Tables/human/CAGE/mapping/h65_mapping.tbl.txt.bz2 $tmpdir/download","perl $tmpdir/download.pl http://fantom.gsc.riken.jp/4/download/Tables/human/CAGE/mapping/h69_mapping.tbl.txt.bz2 $tmpdir/download","perl $tmpdir/download.pl http://fantom.gsc.riken.jp/4/download/Tables/human/CAGE/mapping/h73_mapping.tbl.txt.bz2 $tmpdir/download","perl $tmpdir/download.pl http://fantom.gsc.riken.jp/4/download/Tables/human/CAGE/mapping/h74_mapping.tbl.txt.bz2 $tmpdir/download","perl $tmpdir/download.pl http://fantom.gsc.riken.jp/4/download/Tables/human/CAGE/mapping/h91_mapping.tbl.txt.bz2 $tmpdir/download","perl $tmpdir/download.pl http://fantom.gsc.riken.jp/4/download/Tables/human/CAGE/mapping/h92_mapping.tbl.txt.bz2 $tmpdir/download","perl $tmpdir/download.pl http://fantom.gsc.riken.jp/4/download/Tables/human/CAGE/mapping/h93_mapping.tbl.txt.bz2 $tmpdir/download",
"perl $tmpdir/download.pl http://fantom.gsc.riken.jp/4/download/Tables/human/CAGE/mapping/h95ctrls_mapping.tbl.txt.bz2 $tmpdir/download","perl $tmpdir/download.pl http://fantom.gsc.riken.jp/4/download/Tables/human/CAGE/mapping/i02_mapping.tbl.txt.bz2 $tmpdir/download","perl $tmpdir/download.pl http://fantom.gsc.riken.jp/4/download/Tables/human/CAGE/mapping/i03_mapping.tbl.txt.bz2 $tmpdir/download","temp=\"$tmpdir/output.sam\"","output=\"$tmpdir/output.bam\"","perl $tmpdir/convert_mapping_table_to_sam.pl $tmpdir/download/*.bz2 > $temp","samtools view -bSo $output $temp 2>/dev/null","rm -r $tmpdir/download","rm $temp"],"https://moirai2.github.io/schema/daemon/script":[{"https://moirai2.github.io/schema/daemon/script/name":"$tmpdir/download.pl","https://moirai2.github.io/schema/daemon/script/code":["use LWP::UserAgent;","use HTTP::Request;","use File::Basename;","my $url=shift(@ARGV);","my $outdir=shift(@ARGV);","my $agent=new LWP::UserAgent();","$agent->agent('download.pl/1.0');","$agent->timeout(10);","$agent->env_proxy;","my $request=HTTP::Request->new(GET=>$url);","my $filename=\"$outdir/\".basename($url);","my $res=$agent->request($request);","if($res->is_success){","open(OUT,\">$filename\");","print OUT $res->content;","close(OUT);","}elsif($res->is_error){","exit(1);","}"]},{"https://moirai2.github.io/schema/daemon/script/name":"$tmpdir/convert_mapping_table_to_sam.pl","https://moirai2.github.io/schema/daemon/script/code":["use strict 'vars';","use FileHandle;","use File::Basename;","print \"\\@SQ	SN:chr1	AS:chrom.sizes	LN:249250621\n\";","print \"\\@SQ	SN:chr2	AS:chrom.sizes	LN:243199373\n\";","print \"\\@SQ	SN:chr3	AS:chrom.sizes	LN:198022430\n\";","print \"\\@SQ	SN:chr4	AS:chrom.sizes	LN:191154276\n\";","print \"\\@SQ	SN:chr5	AS:chrom.sizes	LN:180915260\n\";","print \"\\@SQ	SN:chr6	AS:chrom.sizes	LN:171115067\n\";","print \"\\@SQ	SN:chr7	AS:chrom.sizes	LN:159138663\n\";","print \"\\@SQ	SN:chr8	AS:chrom.sizes	LN:146364022\n\";","print \"\\@SQ	SN:chr9	AS:chrom.sizes	LN:141213431\n\";","print \"\\@SQ	SN:chr10	AS:chrom.sizes	LN:135534747\n\";","print \"\\@SQ	SN:chr11	AS:chrom.sizes	LN:135006516\n\";","print \"\\@SQ	SN:chr12	AS:chrom.sizes	LN:133851895\n\";","print \"\\@SQ	SN:chr13	AS:chrom.sizes	LN:115169878\n\";","print \"\\@SQ	SN:chr14	AS:chrom.sizes	LN:107349540\n\";","print \"\\@SQ	SN:chr15	AS:chrom.sizes	LN:102531392\n\";","print \"\\@SQ	SN:chr16	AS:chrom.sizes	LN:90354753\n\";","print \"\\@SQ	SN:chr17	AS:chrom.sizes	LN:81195210\n\";","print \"\\@SQ	SN:chr18	AS:chrom.sizes	LN:78077248\n\";","print \"\\@SQ	SN:chr19	AS:chrom.sizes	LN:59128983\n\";","print \"\\@SQ	SN:chr20	AS:chrom.sizes	LN:63025520\n\";","print \"\\@SQ	SN:chr21	AS:chrom.sizes	LN:48129895\n\";","print \"\\@SQ	SN:chr22	AS:chrom.sizes	LN:51304566\n\";","print \"\\@SQ	SN:chrM	AS:chrom.sizes	LN:16571\n\";","print \"\\@SQ	SN:chrX	AS:chrom.sizes	LN:155270560\n\";","print \"\\@SQ	SN:chrY	AS:chrom.sizes	LN:59373566\n\";","foreach my $file(@ARGV){","  my $basename=basename($file,\"_mapping.tbl.txt.bz2\");","  my $reader=IO::File->new(\"bzip2 -cd $file|\");","  my $preseq;","  my @token;","  while(<$reader>){","    if(/^##/){next;}","    my $line=<$reader>;","    chomp($line);","    @token=split(/\t/,$line);","    $preseq=$token[0];","    last;","  }","  my $hash={\"reader\"=>$reader,\"token\"=>[\@token],\"preseq\"=>$preseq};","  while(defined($preseq)){","    my @token=read_next($hash);","    print_seq($basename,@token);","    $preseq=$hash->{\"preseq\"};","  }","  close($reader);","}","sub print_seq{","  my @lines=@_;","  my $basename=shift(@lines);","  my $maxweight=0;","  foreach my $line(@lines){if($line->[15]>$maxweight){$maxweight=$line->[15];}}","  foreach my $line(@lines){","    my ($seq,$library_count,$edit_string,$rname,$strand,$start,$end,$percentage,$map_pos,$ribo_flag,$refseq_flag,$rna,$rna_count,$tpm_in_ribo,$tpm_ex_ribo,$weight,$rescue_weight)=@{$line};","    $rna=~tr/ /_/;","    my $length=length($seq);","    my $qual=\"\";","    for(my $i=0;$i<$length;$i++){$qual.=\"/\";}","    my $flag=0;","    my $pos=$start;","    my $length=$end-$start+1;","    if($strand eq\"-\"){$flag+=16;$pos=$end;}","    my $cigar=$length.\"M\";","    if($edit_string eq\"ORIGINAL\"){","    }else{","      $cigar=\"\";","      my $index=0;","      foreach my $c(split(/,/,$edit_string)){","        if($c=~/^(\w)(\d+)/){","          my $edit=$1;","          my $pos=$2;","          if($edit eq\"M\"){","          }elsif($edit eq\"I\"){","            if($index<$pos){","              $cigar.=($pos-$index).\"M\";","              $cigar.=\"1I\";","              $index=$pos+1;$length--;","            }","          }elsif($edit eq\"D\"){","            if($pos==$index){","              $cigar.=\"1S\";$length--;$index=$pos;","            }elsif($pos>$index){","              $cigar.=($pos-$index).\"M\";","              $cigar.=\"1D\";$index=$pos-1;","            }","          }","        }","      }","      if($index<$length){$cigar.=($length-$index).\"M\";}","    }","    $cigar=~s/1S1S/2S/;","    for(my $j=0;$j<$rna_count;$j++){","      my $id=\"$basename|$rna|$seq|\".($j+1);","      my $flag2=$flag;","      if($weight<$maxweight){next;}","      print \"$id\t$flag2\t$rname\t$pos\t255\t$cigar\t*\t0\t0\t$seq\t$qual\n\";","    }","  }","}","sub read_next{","  my $hash=shift();","  my $reader=$hash->{\"reader\"};","  my $preseq=$hash->{\"preseq\"};","  my @array=@{$hash->{\"token\"}};","  while(!eof($reader)){","    my $line=<$reader>;","    chomp($line);","    my @token=split(/\t/,$line);","    my $sequence=$token[0];","    if($sequence eq $preseq){","      push(@array,\@token);","    }else{","      $hash->{\"preseq\"}=$sequence;","      $hash->{\"token\"}=[\@token];","      last;","    }","  }","  if(eof($reader)){delete($hash->{\"preseq\"});}","  return @array;","}"]}],"https://moirai2.github.io/schema/daemon/output":"$output"}
